<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Purging Azure CDN With GitHub Actions | Nibbles and Bytes</title><meta name=keywords content="Microsoft Azure,GitHub Actions,Automation,Website"><meta name=description content="GitHub Actions allows you to automate purging Azure CDN so you don’t have to craft caching rules or manually enter the Azure portal."><meta name=author content="Lyndon Shi"><link rel=canonical href=https://lynshi.github.io/posts/@shilyndon/purging-azure-cdn-with-github-actions-1c18e2adaf18/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://lynshi.github.io/favicon/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://lynshi.github.io/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lynshi.github.io/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://lynshi.github.io/favicon/apple-touch-icon.png><link rel=mask-icon href=https://lynshi.github.io/favicon/favicon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})'></script><meta property="og:title" content="Purging Azure CDN With GitHub Actions"><meta property="og:description" content="GitHub Actions allows you to automate purging Azure CDN so you don’t have to craft caching rules or manually enter the Azure portal."><meta property="og:type" content="article"><meta property="og:url" content="https://lynshi.github.io/posts/@shilyndon/purging-azure-cdn-with-github-actions-1c18e2adaf18/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-01T04:13:58+00:00"><meta property="article:modified_time" content="2020-01-01T04:13:58+00:00"><meta property="og:site_name" content="Nibbles and Bytes"><meta name=twitter:card content="summary"><meta name=twitter:title content="Purging Azure CDN With GitHub Actions"><meta name=twitter:description content="GitHub Actions allows you to automate purging Azure CDN so you don’t have to craft caching rules or manually enter the Azure portal."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://lynshi.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Purging Azure CDN With GitHub Actions","item":"https://lynshi.github.io/posts/@shilyndon/purging-azure-cdn-with-github-actions-1c18e2adaf18/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Purging Azure CDN With GitHub Actions","name":"Purging Azure CDN With GitHub Actions","description":"GitHub Actions allows you to automate purging Azure CDN so you don’t have to craft caching rules or manually enter the Azure portal.","keywords":["Microsoft Azure","GitHub Actions","Automation","Website"],"articleBody":" Originally published on Medium.\nWhen you use Azure CDN to deliver content, you may need to purge your endpoint so that changes you make are sent to your users, as files are cached in the Azure CDN until their time-to-live (TTL) expires. If you don’t set a TTL for your files, Azure automatically sets a TTL of 7 days. Even if you set a lower TTL, your updates may not coincide with the cache expiration.\nFor example, my personal website uses Azure CDN and is updated on every push I make to GitHub. It’s tough to set a good caching rule for this because my changes are unpredictable. When I’m working on my site, I might push several times a day, but I can also go weeks without modifying my website.\nWhile it is possible to purge an endpoint through the Azure portal, I wanted to automate this process. Fortunately, this is possible with GitHub Actions.\nCreating a Service Principal An Azure service principal is “an identity created for use with applications, hosted services, and automated tools to access Azure resources”. It is recommended, for better security, to use service principals with automated tools, since access is restricted by roles assigned to the service principal. In this section, I’ll discuss how to create a service principal and give it the CDN Endpoint Contributor role. To get started, you’ll need the Azure CLI.\nTo create a new service principal, enter the following command in your terminal, making sure to copy the correct and from your Azure portal.\naz ad sp create-for-rbac -n \"$nameOfServicePrincipal\" --role \"CDN Endpoint Contributor\" --sdk-auth --scopes \"/subscriptions/$subscriptionId/resourceGroups/$resourceGroup\" The output will look similar to the following; be sure to copy and save it somewhere safe, as you will not be able to retrieve the clientSecret in the future.\n{ \"clientId\": \"\", \"clientSecret\": \"\", \"subscriptionId\": \"\", \"tenantId\": \"\" } In the command, we are creating a service principal and assigning it a role of “CDN Endpoint Contributor”. This allows the service principal to manage CDN endpoints. The --sdk-auth flag causes the output to be correctly formatted for use in the GitHub Action; without it, you will get the following error when you copy the output to GitHub.\nError: Not all values are present in the creds object. Ensure clientId, clientSecret, tenantId and subscriptionId are supplied. Adding GitHub Secrets Add the following secrets (encrypted environment variables) to your GitHub repository:\nAZURE_CREDENTIALS: paste the output from the az ad sp create-for-rbac command. AZURE_CDN_ENDPOINT: the name of your Azure CDN endpoint. AZURE_CDN_PROFILE_NAME: the name of your Azure CDN profile. AZURE_RESOURCE_GROUP: the name of the resource group containing the Azure CDN profile. Writing the GitHub Actions Workflow File Now that you have a service principal and GitHub secrets, all that remains is to write the GitHub Action. There are two essential steps in the workflow: 1) logging in to Azure, and 2) purging the CDN. To start, go to your repository on GitHub and select the “Actions” tab. Click “New workflow”, then choose “Set up a workflow yourself” or the appropriate starter for your needs.\nThe following is the bare minimum required for this workflow.\nThe Azure service principal login step logs in to Azure CLI with the credentials you added to your GitHub secret. The Purge CDN step purges the CDN, so your updates should occur between these two steps. In the Purge CDN step, --content-paths \"/*\" purges all content. --no-wait means the script does not wait for the purge operation to finish before continuing; this flag is optional. You can read more about the az cdn endpoint purge command here.\nThat’s all there is to it, happy coding!\n","wordCount":"607","inLanguage":"en","datePublished":"2020-01-01T04:13:58.567Z","dateModified":"2020-01-01T04:13:58.567Z","author":{"@type":"Person","name":"Lyndon Shi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lynshi.github.io/posts/@shilyndon/purging-azure-cdn-with-github-actions-1c18e2adaf18/"},"publisher":{"@type":"Organization","name":"Nibbles and Bytes","logo":{"@type":"ImageObject","url":"https://lynshi.github.io/favicon/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lynshi.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://lynshi.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lynshi.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://lynshi.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://lynshi.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://lynshi.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lynshi.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://lynshi.github.io/posts/>Posts</a></div><h1 class=post-title>Purging Azure CDN With GitHub Actions</h1><div class=post-description>GitHub Actions allows you to automate purging Azure CDN so you don’t have to craft caching rules or manually enter the Azure portal.</div><div class=post-meta><span title='2020-01-01 04:13:58.567 +0000 UTC'>January 1, 2020</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;607 words&nbsp;·&nbsp;Lyndon Shi&nbsp;|&nbsp;<a href=https://github.com/lynshi/blog/tree/main/content/posts/2020-01-01_Purging-Azure-CDN-With-GitHub-Actions-1c18e2adaf18.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><blockquote><p>Originally published on <a href=https://medium.com/@shilyndon/purging-azure-cdn-with-github-actions-1c18e2adaf18>Medium</a>.</p></blockquote><p>When you use Azure CDN to deliver content, you may need to purge your endpoint so that changes you make are sent to your users, as <a href=https://docs.microsoft.com/en-us/azure/cdn/cdn-manage-expiration-of-cloud-service-content>files are cached in the Azure CDN until their time-to-live (TTL) expires</a>. If you don’t set a TTL for your files, Azure automatically sets a TTL of 7 days. Even if you set a lower TTL, your updates may not coincide with the cache expiration.</p><p>For example, my personal website uses Azure CDN and is updated on every push I make to GitHub. It’s tough to set a good caching rule for this because my changes are unpredictable. When I’m working on my site, I might push several times a day, but I can also go weeks without modifying my website.</p><p>While it is possible to <a href=https://docs.microsoft.com/en-us/azure/cdn/cdn-purge-endpoint>purge an endpoint through the Azure portal</a>, I wanted to automate this process. Fortunately, this is possible with <a href=https://github.com/features/actions>GitHub Actions</a>.</p><h4 id=creating-a-service-principal>Creating a Service Principal<a hidden class=anchor aria-hidden=true href=#creating-a-service-principal>#</a></h4><p>An <a href="https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli?toc=%2Fazure%2Fazure-resource-manager%2Ftoc.json&view=azure-cli-latest">Azure service principal</a> is “an identity created for use with applications, hosted services, and automated tools to access Azure resources”. It is recommended, for better security, to use service principals with automated tools, since access is restricted by roles assigned to the service principal. In this section, I’ll discuss how to create a service principal and give it the <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#cdn-endpoint-contributor>CDN Endpoint Contributor</a> role. To get started, you’ll need the <a href="https://docs.microsoft.com/en-us/cli/azure/get-started-with-azure-cli?view=azure-cli-latest">Azure CLI</a>.</p><p>To create a new service principal, enter the following command in your terminal, making sure to copy the correct<code>&lt;subscription_id></code> and <code>&lt;resource_group_name></code> from your Azure portal.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>az ad sp create-for-rbac -n <span class=s2>&#34;</span><span class=nv>$nameOfServicePrincipal</span><span class=s2>&#34;</span> --role <span class=s2>&#34;CDN Endpoint Contributor&#34;</span> --sdk-auth --scopes <span class=s2>&#34;/subscriptions/</span><span class=nv>$subscriptionId</span><span class=s2>/resourceGroups/</span><span class=nv>$resourceGroup</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>The output will look similar to the following; be sure to copy and save it somewhere safe, as you will not be able to retrieve the <code>clientSecret</code> in the future.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;clientId&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;GUID&gt;&#34;</span><span class=p>,</span>                               
</span></span><span class=line><span class=cl>  <span class=nt>&#34;clientSecret&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;GUID&gt;&#34;</span><span class=p>,</span>                           
</span></span><span class=line><span class=cl>  <span class=nt>&#34;subscriptionId&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;GUID&gt;&#34;</span><span class=p>,</span>                         
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tenantId&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;GUID&gt;&#34;</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In the <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest#az-ad-sp-create">command</a>, we are creating a service principal and assigning it a role of “CDN Endpoint Contributor”. This allows the service principal to manage CDN endpoints. The <code>--sdk-auth</code> flag causes the output to be correctly formatted for use in the GitHub Action; without it, you will get the following error when you copy the output to GitHub.</p><pre tabindex=0><code>Error: Not all values are present in the creds object. Ensure clientId, clientSecret, tenantId and subscriptionId are supplied.
</code></pre><h4 id=adding-githubsecrets>Adding GitHub Secrets<a hidden class=anchor aria-hidden=true href=#adding-githubsecrets>#</a></h4><p>Add the following secrets (encrypted environment variables) to your GitHub repository:</p><ol><li><code>AZURE_CREDENTIALS</code>: paste the output from the <code>az ad sp create-for-rbac</code> command.</li><li><code>AZURE_CDN_ENDPOINT</code>: the name of your Azure CDN endpoint.</li><li><code>AZURE_CDN_PROFILE_NAME</code>: the name of your Azure CDN profile.</li><li><code>AZURE_RESOURCE_GROUP</code>: the name of the resource group containing the Azure CDN profile.</li></ol><p><img loading=lazy src=/img/medium/1__RwM3IOTXVjwtQCcMkDWW__A.png alt></p><h4 id=writing-the-github-actions-workflowfile>Writing the GitHub Actions Workflow File<a hidden class=anchor aria-hidden=true href=#writing-the-github-actions-workflowfile>#</a></h4><p>Now that you have a service principal and GitHub secrets, all that remains is to write the GitHub Action. There are two essential steps in the workflow: 1) logging in to Azure, and 2) purging the CDN. To start, go to your repository on GitHub and select the “Actions” tab. Click “New workflow”, then choose “Set up a workflow yourself” or the appropriate starter for your needs.</p><p>The following is the bare minimum required for this workflow.</p><p>The <code>Azure service principal login</code> step logs in to Azure CLI with the credentials you added to your GitHub secret. The <code>Purge CDN</code> step purges the CDN, so your updates should occur between these two steps. In the <code>Purge CDN</code> step, <code>--content-paths "/*"</code> purges all content. <code>--no-wait</code> means the script does not wait for the purge operation to finish before continuing; this flag is optional. You can read more about the <code>az cdn endpoint purge</code> command <a href="https://docs.microsoft.com/en-us/cli/azure/cdn/endpoint?view=azure-cli-latest#az-cdn-endpoint-purge">here</a>.</p><p>That’s all there is to it, happy coding!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://lynshi.github.io/tags/microsoft-azure/>Microsoft Azure</a></li><li><a href=https://lynshi.github.io/tags/github-actions/>GitHub Actions</a></li><li><a href=https://lynshi.github.io/tags/automation/>Automation</a></li><li><a href=https://lynshi.github.io/tags/website/>Website</a></li></ul><nav class=paginav><a class=prev href=https://lynshi.github.io/posts/understanding-ewd998/><span class=title>« Prev</span><br><span>Understanding EWD998: Shmuel Safra's version of termination detection</span></a>
<a class=next href=https://lynshi.github.io/posts/@shilyndon/automating-deployment-of-a-gatsby-static-website-on-azure-storage-with-github-actions-c81a63b32a9a/><span class=title>Next »</span><br><span>Automating Deployment of a (Gatsby) Static Website on Azure Storage with GitHub Actions</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://lynshi.github.io/>Nibbles and Bytes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>